#code

#  Author: Jael Rojas Miguel
Smart question: Is there a relationship between airport and delay frequency/type of delay?

In this subsequent modeling, we use ARR_DEL15 (arrival delay ≥ 15 minutes) as the main indicator of a late arrival,
and explore how airline, origin/destination, and other delay components predict this outcome.
The regulations in U.S. and international on‑time performance reporting, a flight is considered on time if it arrives
at the gate less than 15 minutes after scheduled arrival; arriving 15 minutes or more late is counted as a delay.











We will use machine learning to predict flight delays for the next month using data from the BTS TranStats from January to July 2025. 

Most importatnt Variable used:

ARR_DEL15: Binary flag indicating if the arrival was delayed by 15+ minutes (this is your target variable).​
OP_UNIQUE_CARRIER: Airline code to identify the carrier.​
ORIGIN and DEST: Airport codes for origin and destination airports.​
DAY_OF_WEEK: Day of the week (1=Monday, 7=Sunday).​
CRS_DEP_TIME: Scheduled departure time, often used as a time window or block.​
CRS_ARR_TIME: Scheduled arrival time.​
DEP_DEL15: Binary flag for departure delay of 15+ minutes (can be a predictor).​
DISTANCE: Flight distance in miles.​
DELAY_DUE_TO_CARRIER, WEATHER, NAS, SECURITY, LATE_AIRCRAFT: Cause-specific delay flags, which help capture the reasons for delays.​
MONTH, YEAR: Temporal variables to capture seasonal and yearly effects.​
CANCELLATION_CODE: Indicates if the flight was canceled and why.​
DIVERTED: Flag if the flight was diverted.​
Additional Useful Variables
DEP_TIME_BLK and ARR_TIME_BLK: Time windows for departure and arrival.​
TAXI_OUT and TAXI_IN: Taxi times, which can be correlated with airport congestion.


The code reads and merges CSV files for January to July, selects relevant columns, preprocesses data, and trains a logistic regression model to predict the probability of a delay (ARR_DEL15 = 1).

```{r}
library(dplyr)
library(readr)
library(purrr)
library(tidyr)


# Read monthly files
csv_files <- list.files(
  path = "C:/Users/Jael Rojas/Documents/MS_DataScience/DataScience/finalreport/traindata/months",
  pattern = "*.csv", full.names = TRUE
)

flights_list <- csv_files %>%
  map(~ read_csv(.x, show_col_types = FALSE) %>%
        mutate(
          CRS_DEP_TIME = as.character(CRS_DEP_TIME),
          CRS_ARR_TIME = as.character(CRS_ARR_TIME)
        ))

flights_all <- bind_rows(flights_list)

# Keep only major US airlines
major_airlines <- c("AA","DL","UA","WN","AS","B6","HA","F9","NK")

flights_all <- flights_all %>%
  filter(OP_UNIQUE_CARRIER %in% major_airlines)

# Keep top 50 airports by origin frequency (both origin & dest)
top_airports <- flights_all %>%
  count(ORIGIN, sort = TRUE) %>%
  slice_head(n = 10) %>%
  pull(ORIGIN)

flights_all <- flights_all %>%
  filter(ORIGIN %in% top_airports,
         DEST   %in% top_airports)
```

```{r}
# Drop NAs only in variables used for prediction
flights_all <- flights_all %>%
  drop_na(ARR_DEL15, OP_UNIQUE_CARRIER, ORIGIN, DEST,
          DAY_OF_WEEK, CRS_DEP_TIME, CRS_ARR_TIME,
          DEP_DEL15, DISTANCE, MONTH)

# Remove cause‑minute columns (used only for ex‑post analysis)
flights_all <- flights_all %>%
  select(-CANCELLATION_CODE, -CARRIER_DELAY, -WEATHER_DELAY, -NAS_DELAY,
         -SECURITY_DELAY, -LATE_AIRCRAFT_DELAY)

# Convert categorical predictors to factors
flights_all <- flights_all %>%
  mutate(
    OP_UNIQUE_CARRIER = as.factor(OP_UNIQUE_CARRIER),
    ORIGIN            = as.factor(ORIGIN),
    DEST              = as.factor(DEST),
    DEP_TIME_BLK      = as.factor(DEP_TIME_BLK),
    ARR_TIME_BLK      = as.factor(ARR_TIME_BLK)
  )
```

```{r}
# Train on months < 7, test on month == 7
train_data <- flights_all %>% filter(MONTH < 7)
test_data  <- flights_all %>% filter(MONTH == 7)

# Keep only needed columns in training set
train_data <- train_data %>%
  select(ARR_DEL15, OP_UNIQUE_CARRIER, ORIGIN, DEST,
         DAY_OF_WEEK, CRS_DEP_TIME, CRS_ARR_TIME,
         DEP_DEL15, DISTANCE, MONTH, YEAR,
         DEP_TIME_BLK, ARR_TIME_BLK, TAXI_OUT, TAXI_IN, DIVERTED)
names(train_data)

model <- glm(
  ARR_DEL15 ~ OP_UNIQUE_CARRIER + ORIGIN + DEST +
    DAY_OF_WEEK + DISTANCE + MONTH +
    DEP_TIME_BLK + ARR_TIME_BLK,
  data = train_data,
  family = binomial
)
summary(model)
```


```{r}
#install.packages("pROC")
library(pROC)

# Predicted probabilities on test set
test_data$pred_prob <- predict(model, newdata = test_data, type = "response")

# ROC object and AUC
roc_obj <- roc(response = test_data$ARR_DEL15,
               predictor = test_data$pred_prob)
auc(roc_obj)        # numeric AUC
plot(roc_obj, col = "blue", main = "ROC curve - flight delay model")
```

```{r}
#install.packages("PRROC") 
library(PRROC)

# Scores for positive (delayed) and negative (on-time) classes
fg <- test_data$pred_prob[test_data$ARR_DEL15 == 1]  # foreground: positives
bg <- test_data$pred_prob[test_data$ARR_DEL15 == 0]  # background: negatives

# PR curve and area under PR curve
pr_obj <- pr.curve(scores.class0 = fg, scores.class1 = bg, curve = TRUE)
pr_obj$auc.integral   

# Plot precision–recall curve
plot(pr_obj, main = "Precision–Recall curve for flight delay model")
```

```{r}
next_month_data <- data.frame(
  OP_UNIQUE_CARRIER = c("AA","DL","UA","WN","AS","B6","F9","NK","AA","DL"),
  ORIGIN = c("ATL","ATL","ORD","DFW","SEA","LAS","LAX","PHX","DEN","MCO"),
  DEST   = c("CLT","DEN","ATL","LAS","LAX","ORD","SEA","LAX","PHX","ATL"),
  DAY_OF_WEEK = c(1,2,3,4,5,6,7,1,3,5),
  DISTANCE = c(226, 1068, 606, 1055, 954, 1514, 954, 296, 602, 403),  # use real or approximate miles
  MONTH = rep(8, 10),   # e.g., predicting for August
  DEP_TIME_BLK = c("0800-0859","1500-1559","1900-1959","1200-1259","1700-1759",
                   "1000-1059","1400-1459","0600-0659","1600-1659","2000-2059"),
  ARR_TIME_BLK = c("1000-1059","1700-1759","2100-2159","1400-1459","1900-1959",
                   "1200-1259","1600-1659","0800-0859","1800-1859","2200-2259"),
  stringsAsFactors = FALSE
)


next_month_data$OP_UNIQUE_CARRIER <-
  factor(next_month_data$OP_UNIQUE_CARRIER,
         levels = levels(train_data$OP_UNIQUE_CARRIER))
library(dplyr)
next_month_data <- next_month_data %>%
  filter(!is.na(OP_UNIQUE_CARRIER))
next_month_data$ORIGIN <-
  factor(next_month_data$ORIGIN,
         levels = levels(train_data$ORIGIN))
next_month_data$DEST <-
  factor(next_month_data$DEST,
         levels = levels(train_data$DEST))
next_month_data$DEP_TIME_BLK <-
  factor(next_month_data$DEP_TIME_BLK,
         levels = levels(train_data$DEP_TIME_BLK))
next_month_data$ARR_TIME_BLK <-
  factor(next_month_data$ARR_TIME_BLK,
         levels = levels(train_data$ARR_TIME_BLK))
```

```{r}
next_month_data$pred_prob_delay <- predict(
  model,
  newdata = next_month_data,
  type = "response"
)

threshold <- 0.5
next_month_data$pred_delayed_flag <-
  ifelse(next_month_data$pred_prob_delay >= threshold, 1, 0)
next_month_data
```

```{r}
library(ggplot2)
ggplot(next_month_data,
       aes(x = interaction(OP_UNIQUE_CARRIER, ORIGIN, DEST),
           y = pred_prob_delay,
           fill = factor(pred_delayed_flag))) +
  geom_col() +
  labs(x = "Carrier-Origin-Dest",
       y = "Predicted delay probability",
       fill = "Predicted delayed") +
  ylim(0, 1) +
  theme_minimal()
```

```{r}
ggplot(next_month_data,
       aes(x = DAY_OF_WEEK, y = pred_prob_delay,
           color = OP_UNIQUE_CARRIER)) +
  geom_point(size = 3) +
  labs(x = "Day of week",
       y = "Predicted delay probability") +
  ylim(0, 1) +
  theme_minimal()
```





