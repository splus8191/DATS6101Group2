---
title: "Data Science Project 2 Airline Data"
author: "Laura Escher"
date: "2025-12-04"
output: html_document
---

```{r setup, include=FALSE}
# Some of common RMD options (and the defaults) are: 
# include=T, eval=T, echo=T, results='hide'/'asis'/'markup',..., collapse=F, warning=T, message=T, error=T, cache=T, fig.width=6, fig.height=4, fig.dim=c(6,4) #inches, fig.align='left'/'center','right', 
knitr::opts_chunk$set(results="markup", warning = F, message = F)
options(scientific=T, digits = 3) 
```

# Link to GitHub Repository and loading in packages
Here is a link to our repository: https://github.com/splus8191/DATS6101Group2

```{r setup and loading packages}
library(ggplot2)
library(dplyr)
library(tidyr)
library(ezids)
library(car)
library(modelsummary)
library(stats)
library(knitr)
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)

options(scientific=T, digits = 3)
```

Our research purpose is to determine which variables predict a late arrival for flights in the U.S. and
the degree in which they influence a late arrival. To phrase it as a question, “What are the main
determinants for a late arrival in the U.S.?” 

# EDA For the Airline Dataset

```{r}
airdata <- read.csv("C:/Users/esche_zla0rp6/OneDrive - The George Washington University/Intro to Data Science/Data Science Project 2/sample airline data.csv")

colSums(is.na(airdata))
sum(is.na(airdata))
```

We first opened up the file and examined the data using the str() function. We checked to see if there are any missing values in the data, which there are 2,425,691 across different columns and rows. There are 529,747 observations in this data set, and 27 variables. This data is flight specific during the month of January 2025. The variables are:

Variable  |  Definition

- YEAR | Year 2025
- MONTH | Month (MM) January
- DAY_OF_MONTH | Day of the month 1-31
- DAY_OF_WEEK | Day of the week 1(Monday) -7(Sunday).
- OP_UNIQUE_CARRIER | Unique Carrier Code. When the same code has been used by multiple carriers, a numeric suffix is used for earlier users, for example, PA, PA(1), PA(2). Use this field for analysis across a range of years.
- ORIGIN | Origin airport
- ORIGIN_CITY_NAME | Origin Airport, City Name
- DEST | Destination Airport
- DEST_CITY_NAME | Destination Airport, City Name
- CRS_DEP_TIME | CRS Departure Time (local time: hhmm)
- DEP_TIME | Actual Departure Time (local time: hhmm)
- DEP_DELAY | Difference in minutes between scheduled and actual departure time. Early departures show negative numbers.
- DEP_DELAY_NEW | Difference in minutes between scheduled and actual departure time. Early departures set to 0.
- DEP_DEL15 | Departure Delay Indicator, 15 Minutes or More (1=Yes, 0=No)
- CRS_ARR_TIME | CRS Arrival Time (local time: hhmm)
- ARR_TIME | Actual Arrival Time (local time: hhmm)
- ARR_DELAY |	Difference in minutes between scheduled and actual arrival time. Early arrivals show negative numbers.
- ARR_DELAY_NEW | Difference in minutes between scheduled and actual arrival time. Early arrivals set to 0.
- ARR_DEL15 | Arrival Delay Indicator, 15 Minutes or More (1=Yes, 0=No)
- AIR_TIME | Flight Time, in Minutes
- DISTANCE | Distance between airports (miles)
- DISTANCE_GROUP | 
- CARRIER_DELAY | Carrier Delay, in Minutes
- WEATHER_DELAY | Weather Delay, in Minutes	
- NAS_DELAY | National Air System Delay, in Minutes	
- SECURITY_DELAY | Security Delay, in Minutes
- LATE_AIRCRAFT_DELAY | Late Aircraft Delay, in Minutes

YEAR, MONTH, DAY_OF_MONTH, DAY_OF_WEEK, OP_UNIQUE_CARRIER, airline, ORIGIN, ORIGIN_CITY_NAME, DEST, DEST_CITY_NAME, CRS_DEP_TIME, DEP_TIME, DEP_DELAY, DEP_DELAY_NEW, DEP_DEL15, DISTANCE, CRS_ARR_TIME, ARR_TIME, ARR_DELAY, ARR_DELAY_NEW, ARR_DEL15, AIR_TIME, DISTANCE, DISTANCE_GROUP, CARRIER_DELAY, WEATHER_DELAY, NAS_DELAY, SECURITY_DELAY, LATE_AIRCRAFT_DELAY, delay15

# SMART Questions

Our SMART Questions for this analysis are:
- Which of the major airlines have the most reliable on-time performance for airports?
- Is there a relationship between airport and delay frequency/type of delay?
- Is there a relationship between airline brand and delay frequency/type of delay? <-- we are mostly working on this one right now.

# EDA

Before filtering the data, how many airlines are there in the dataset?
```{r}
airlinecode <- c('DL', 'WN', 'B6', 'UA', 'AA', 'G4', 'F9', 'HA', 'AS', 'MQ', 'NK', 'PS', 'OO', 'YX', 'NA')

airlinecode1 <- data.frame(
  OP_UNIQUE_CARRIER = c('DL', 'WN', 'B6', 'UA', 'AA', 'G4', 'F9', 'HA', 'AS', 'MQ', 'NK', 'PS', 'OO', 'YX', 'NA'),
  airline = c('Delta', 'Southwest', 'JetBlue', 'United', 'American', 'Allegiant',
              'Frontier', 'Hawaiian', 'Alaska', 'EnvoyAir', 'Spirit', 'PSA', 'SkyWest', 'Republic', 'NorthAmerican')
)

airdata1 <- airdata %>%
  left_join(airlinecode1, by = "OP_UNIQUE_CARRIER")

# airdata %>%
#   count(OP_UNIQUE_CARRIER)

ggplot(data = airdata1, aes(x = airline)) +
  geom_bar(fill = 'blue') +
  labs(title = "Number of Airlines",
       x = "Airlines",
       y = "Number of Flights by Airline") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 0.5))
```

There are 14 airlines total that flew in January 2025.

Now, before analyzing the data further, we will match airline codes to airlines. Then, we will filter by the 9 major airlines in the U.S.: Delta, Southwest, JetBlue, United, American, Allegiant, Frontier, Hawaiian, and Alaska. We also make a new variable called "delay_minutes" to sum departure and arrival delays into one column for later analysis.
```{r}
major <- c('DL', 'WN', 'B6', 'UA', 'AA', 'G4', 'F9', 'HA', 'AS')

airlinename <- data.frame(
  OP_UNIQUE_CARRIER = c('DL', 'WN', 'B6', 'UA', 'AA', 'G4', 'F9', 'HA', 'AS'),
  airline = c('Delta', 'Southwest', 'JetBlue', 'United', 'American', 'Allegiant',
              'Frontier', 'Hawaiian', 'Alaska')
)

majorairline <- airdata %>%
  filter(OP_UNIQUE_CARRIER %in% major) %>%
  left_join(airlinename, by = "OP_UNIQUE_CARRIER") %>%
  select(YEAR, MONTH, DAY_OF_MONTH, DAY_OF_WEEK, OP_UNIQUE_CARRIER, airline, ORIGIN, ORIGIN_CITY_NAME, DEST, DEST_CITY_NAME, CRS_DEP_TIME, DEP_TIME, DEP_DELAY, DEP_DELAY_NEW, DEP_DEL15, DISTANCE, CRS_ARR_TIME, ARR_TIME, ARR_DELAY, ARR_DELAY_NEW, ARR_DEL15, AIR_TIME, DISTANCE_GROUP, CARRIER_DELAY, WEATHER_DELAY, NAS_DELAY, SECURITY_DELAY, LATE_AIRCRAFT_DELAY) %>%
  mutate(delay_minutes = (DEP_DELAY_NEW + ARR_DELAY_NEW))

sum(is.na(majorairline))
colSums(is.na(majorairline))
```
Before moving forward, once again, the five types of delays all have the same number of NAs at 317,538 each. Are there any such cases where there are zeros across the five types? Maybe the Bureau of Transportation Statistics should have put zeros where they were needed.
```{r}
fivedelays_zero <- majorairline %>%
   filter(WEATHER_DELAY == 0,
          NAS_DELAY == 0,
          LATE_AIRCRAFT_DELAY == 0,
          CARRIER_DELAY == 0,
          SECURITY_DELAY == 0
          )
nrow(fivedelays_zero)
```
There are zero observations from the filtering the data set for cases where there are zeros across the five delay types.

Now, let's clean out the rest of the 1,694,386 NAs from the analysis. We will do this by routing true zeros to the NAs in the five types of delays when delay_minutes equals zero across those columns. This leaves us with zero NAs in our data set with 277,538 observations total. Additionally, we created indicator variables for the types of delays. We are left with 35 variables.

```{r}
majorairline <- majorairline %>%
  mutate(is_delayed = ifelse(majorairline$delay_minutes == 0, 0, 1))

delay_cols <- c("CARRIER_DELAY", "NAS_DELAY", "SECURITY_DELAY",
                "LATE_AIRCRAFT_DELAY", "WEATHER_DELAY")

majorairline[delay_cols] <- lapply(delay_cols, function(col) {
  ifelse(majorairline$delay_minutes == 0 & is.na(majorairline[[col]]),
         0,
         majorairline[[col]])
})

majorairline <- majorairline %>%
  mutate(carrier_delay_ind = if_else(CARRIER_DELAY > 0, 1, 0),
         weather_delay_ind = if_else(WEATHER_DELAY > 0, 1, 0),
         nas_delay_ind = if_else(NAS_DELAY > 0, 1, 0),
         security_delay_ind = if_else(SECURITY_DELAY > 0, 1, 0),
         lateaircraft_delay_ind = if_else(LATE_AIRCRAFT_DELAY > 0, 1, 0)) %>%
  drop_na()

sum(is.na(majorairline))
```
## Number of Flights Left Per Airline

```{r}
flights_per_airline <- majorairline %>%
  group_by(airline) %>%
  summarise(n_flights = n()) %>%
  arrange(desc(n_flights))

kable(flights_per_airline)

ggplot(data = majorairline, aes(x = airline)) +
  geom_bar(fill = 'blue') +
  labs(title = "Number of Flights Per Airline",
       x = "Airlines",
       y = "Number of Flights by Airline") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 0.5))
```

## Delay rate by airline

Perhaps some airlines are delayed more than others. We compare airlines and their probability of being delayed below.

```{r}
delay_summary <- majorairline %>%
  group_by(airline) %>%
  summarise(p_delay = mean(is_delayed), n = n())
print(delay_summary)

ggplot(data = delay_summary, aes(x = airline, y = p_delay)) +
  geom_bar(stat = "identity", fill = 'darkseagreen') +
  labs(title = "Proportion of Delayed Flights by Airline",
       x = "Airline",
       y = "Proportion of Delays") +
  theme_minimal()
```
JetBlue and Frontier have the highest delay rates at 32.4% and 32.5%.

The lowest delay rates are Southwest at 21.3% and Hawaiian at 20.3%.

The sample sizes (n) are largest for American, Delta, Southwest, and United, so their statistics are likely more stable.

All airlines in the sample have departure delay rates above ___, which is quite high compared to typical industry averages, where usually 15-30% of flights experience significant delays.

There are a significant number of outliers in the data set, so we can create a box plot to illustrate if there is a difference between the airlines and their delay minutes.

```{r}
ggplot(
  data = majorairline %>% filter(delay_minutes > 0, delay_minutes <= 150),
  aes(x = airline, y = delay_minutes)
) +
  geom_boxplot() +
  labs(
    title = "Delay Minutes by Airline (Under 150 Minutes or 2.5 hour delay)",
    x = "Airline",
    y = "Delay Minutes"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Delay Type Rates by Airline

```{r}
avg_delay_type <- majorairline %>%
  group_by(airline) %>%
  summarize(
    Weather = mean(weather_delay_ind),
    NAS = mean(nas_delay_ind),
    Carrier = mean(carrier_delay_ind),
    Security = mean(security_delay_ind),
    `Late Aircraft` = mean(lateaircraft_delay_ind),
    n_flights = n()
  ) %>%
    pivot_longer(
    cols = c(Weather, NAS, Carrier, Security, `Late Aircraft`),
    names_to = "delay_type",
    values_to = "rate"
  )

ggplot(avg_delay_type, aes(x = airline, y = rate, fill = delay_type)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette = "Set2", name = "Delay Type") +
  labs(title = "Delay Type Rates by Airline",
       x = "Airline",
       y = "Rate of Occurrence") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "top")
```

Here are the weather delays by airline type:
```{r}
weather_only <- majorairline %>% filter(WEATHER_DELAY > 0)

ggplot(weather_only, aes(x = airline, y = WEATHER_DELAY, fill = airline)) +
  geom_boxplot(outlier.alpha = 0.3) +
  coord_flip() +
  scale_y_continuous(limits = c(0, 150)) +
  labs(title = "Weather Delay Duration by Airline",
       subtitle = "Flights with actual weather delays only",
       x = "Airline",
       y = "Weather Delay (minutes)") +
  theme_minimal() +
  theme(legend.position = "none")
```

Here are NAS delays by airline.
```{r}
nas_only <- majorairline %>% filter(NAS_DELAY > 0)

ggplot(nas_only, aes(x = airline, y = NAS_DELAY, fill = airline)) +
  geom_boxplot(outlier.alpha = 0.3) +
  coord_flip() +
  scale_y_continuous(limits = c(0, 150)) +
  labs(title = "NAS Delay Duration by Airline",
       subtitle = "Flights with actual NAS delays only",
       x = "Airline",
       y = "NAS Delay (minutes)") +
  theme_minimal() +
  theme(legend.position = "none")
```

Here are the security delays per airline.
```{r}
security_only <- majorairline %>% filter(SECURITY_DELAY > 0)

ggplot(security_only, aes(x = airline, y = SECURITY_DELAY, fill = airline)) +
  geom_boxplot(outlier.alpha = 0.3) +
  coord_flip() +
  scale_y_continuous(limits = c(0, 150)) +
  labs(title = "Security Delay Duration by Airline",
       subtitle = "Flights with actual security delays only",
       x = "Airline",
       y = "Security Delay (minutes)") +
  theme_minimal() +
  theme(legend.position = "none")
```

Here are the carrier delays per airline.
```{r}
carrier_only <- majorairline %>% filter(CARRIER_DELAY > 0)

ggplot(carrier_only, aes(x = airline, y = CARRIER_DELAY, fill = airline)) +
  geom_boxplot(outlier.alpha = 0.3) +
  coord_flip() +
  scale_y_continuous(limits = c(0, 150)) +
  labs(title = "Carrier Delay Duration by Airline",
       subtitle = "Flights with actual carrier delays only",
       x = "Airline",
       y = "Carrier Delay (minutes)") +
  theme_minimal() +
  theme(legend.position = "none")
```

Here are the late aircraft delays per airline.
```{r}
lateaircraft_only <- majorairline %>% filter(LATE_AIRCRAFT_DELAY > 0)

ggplot(lateaircraft_only, aes(x = airline, y = LATE_AIRCRAFT_DELAY, fill = airline)) +
  geom_boxplot(outlier.alpha = 0.3) +
  coord_flip() +
  scale_y_continuous(limits = c(0, 150)) +
  labs(title = "Late Aircraft Delay Duration by Airline",
       subtitle = "Flights with actual late aircraft delays only",
       x = "Airline",
       y = "Aircraft Delay (minutes)") +
  theme_minimal() +
  theme(legend.position = "none")
```

## EDA for Origin Airport and Destination Airport Delay Probabilities

```{r}
originairport_summary <- majorairline %>%
  group_by(ORIGIN_CITY_NAME) %>%
  summarize(
    delay_rate = mean(is_delayed),
    n_flights = n()
  ) %>%
  filter(n_flights >= 100)

worst_25 <- originairport_summary %>%
  arrange(desc(delay_rate)) %>%
  head(25)

ggplot(worst_25, aes(x = reorder(ORIGIN_CITY_NAME, delay_rate), y = delay_rate)) +
  geom_col(fill = "coral", alpha = 0.8) +
  geom_text(aes(label = paste0(round(delay_rate * 100, 1), "%")), 
            hjust = -0.1, size = 3) +
  coord_flip() +
  scale_y_continuous(labels = scales::percent, 
                     limits = c(0, max(worst_25$delay_rate) * 1.1)) +
  labs(title = "Top 25 Origin Airports with Highest Delay Rates",
       subtitle = "Airports with 100+ flights only",
       x = "Origin Airport", 
       y = "Proportion of Delayed Flights") +
  theme_minimal()
```

```{r}
destairport_summary <- majorairline %>%
  group_by(DEST_CITY_NAME) %>%
  summarize(
    delay_rate = mean(is_delayed),
    n_flights = n()
  ) %>%
  filter(n_flights >= 100)

destworst_25 <- destairport_summary %>%
  arrange(desc(delay_rate)) %>%
  head(25)

ggplot(destworst_25, aes(x = reorder(DEST_CITY_NAME, delay_rate), y = delay_rate)) +
  geom_col(fill = "cadetblue3", alpha = 0.8) +
  geom_text(aes(label = paste0(round(delay_rate * 100, 1), "%")), 
            hjust = -0.1, size = 3) +
  coord_flip() +
  scale_y_continuous(labels = scales::percent, 
                     limits = c(0, max(destworst_25$delay_rate) * 1.1)) +
  labs(title = "Top 25 Destination Airports with Highest Delay Rates",
       subtitle = "Airports with 100+ flights only",
       x = "Destination Airport", 
       y = "Proportion of Delayed Flights") +
  theme_minimal()
```

## Convert categorical variables to factors

```{r}
majorairline$airline <- as.factor(majorairline$airline)
majorairline$OP_UNIQUE_CARRIER <- as.factor(majorairline$OP_UNIQUE_CARRIER)
majorairline$OP_CARRIER <- as.factor(majorairline$OP_UNIQUE_CARRIER)
majorairline$DEP_DEL15 <- as.factor(majorairline$DEP_DEL15)
majorairline$MONTH <- as.factor(majorairline$MONTH)
majorairline$DAY_OF_WEEK <- as.factor(majorairline$DAY_OF_WEEK)
```

# Statistical Tests

## Chi-square test: Airline vs Delay Type

```{r}
tab <- table(majorairline$airline, majorairline$is_delayed)
chisq.test(tab)

chisq.test(majorairline$airline, majorairline$carrier_delay_ind)
chisq.test(majorairline$airline, majorairline$weather_delay_ind)
chisq.test(majorairline$airline, majorairline$nas_delay_ind)
chisq.test(majorairline$airline, majorairline$security_delay_ind)
chisq.test(majorairline$airline, majorairline$lateaircraft_delay_ind)
```

## ANOVA tests delay in minutes (quantitative dependent) VS airline (factor variable)

```{r}
anova1 <- aov(delay_minutes ~ airline, data = majorairline)
summary(anova1)
TukeyHSD(anova1)
```

# Statistical Modeling

## Logistic regression:

```{r}
logit_model <- glm(is_delayed ~ airline + DAY_OF_WEEK + CRS_DEP_TIME + C DISTANCE + CARRIER_DELAY + WEATHER_DELAY + NAS_DELAY + SECURITY_DELAY + LATE_AIRCRAFT_DELAY, data = majorairline, family = binomial)
summary(logit_model)
```

# Correlation of numeric variables
```{r}
datasummary_correlation(majorairline %>% select_if(is.numeric))
```

```{r}
correlation1 <- cor(majorairline$LATE_AIRCRAFT_DELAY, majorairline$delay_minutes,
                   use = "complete.obs")
correlation2 <- cor(majorairline$CARRIER_DELAY, majorairline$delay_minutes,
                   use = "complete.obs")
correlation3 <- cor(majorairline$WEATHER_DELAY, majorairline$delay_minutes,
                   use = "complete.obs")
correlation4 <- cor(majorairline$NAS_DELAY, majorairline$delay_minutes,
                   use = "complete.obs"))
correlation5 <- cor(majorairline$SECURITY_DELAY, majorairline$delay_minutes,
                   use = "complete.obs"))

ggplot(majorairline, aes(x = LATE_AIRCRAFT_DELAY, y = delay_minutes)) +
  geom_point(color = "steelblue", size = 3, alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "black", linewidth = 1) +
  labs(title = "test",
       x = "distance",
       y = "delay minutes",
       caption = paste("Correlation coefficient: r =", round(correlation, 3))) +
  scale_x_continuous(labels = scales::comma) +
  scale_y_continuous(labels = scales::comma) +
  theme_classic() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 13),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text = element_text(color = "black", size = 11),
    plot.caption = element_text(hjust = 0, size = 11, face = "italic")
  )


```ggplot(majorairline, aes(x = CARRIER_DELAY, y = delay_minutes)) +
  geom_point(color = "lightpink", size = 3, alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "black", linewidth = 1) +
  labs(title = "test",
       x = "distance",
       y = "delay minutes",
       caption = paste("Correlation coefficient: r =", round(correlation, 3))) +
  scale_x_continuous(labels = scales::comma) +
  scale_y_continuous(labels = scales::comma) +
  theme_classic() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 13),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text = element_text(color = "black", size = 11),
    plot.caption = element_text(hjust = 0, size = 11, face = "italic")
  )

ggplot(majorairline, aes(x = WEATHER_DELAY, y = delay_minutes)) +
  geom_point(color = "lightpink", size = 3, alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "black", linewidth = 1) +
  labs(title = "test",
       x = "distance",
       y = "delay minutes",
       caption = paste("Correlation coefficient: r =", round(correlation, 3))) +
  scale_x_continuous(labels = scales::comma) +
  scale_y_continuous(labels = scales::comma) +
  theme_classic() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 13),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text = element_text(color = "black", size = 11),
    plot.caption = element_text(hjust = 0, size = 11, face = "italic")

  )
