#code

#  Author: Jael Rojas Miguel
We will use machine learning to predict flight delays for the next month using data from the BTS TranStats from January to July 2025. 
Smart question: Is the delay issues enough to predict for the next month?


Most important Variables used:

ARR_DEL15: Binary flag indicating if the arrival was delayed by 15+ minutes (this is your target variable).​
OP_UNIQUE_CARRIER: Airline code to identify the carrier.​
ORIGIN and DEST: Airport codes for origin and destination airports.​
DAY_OF_WEEK: Day of the week (1=Monday, 7=Sunday).​
CRS_DEP_TIME: Scheduled departure time, often used as a time window or block.​
CRS_ARR_TIME: Scheduled arrival time.​
DEP_DEL15: Binary flag for departure delay of 15+ minutes (can be a predictor).​
DISTANCE: Flight distance in miles.​
DELAY_DUE_TO_CARRIER, WEATHER, NAS, SECURITY, LATE_AIRCRAFT: Cause-specific delay flags, which help capture the reasons for delays.​
MONTH, YEAR: Temporal variables to capture seasonal and yearly effects.​
CANCELLATION_CODE: Indicates if the flight was canceled and why.​
DIVERTED: Flag if the flight was diverted.​
Additional Useful Variables
DEP_TIME_BLK and ARR_TIME_BLK: Time windows for departure and arrival.​
TAXI_OUT and TAXI_IN: Taxi times, which can be correlated with airport congestion.

---
title: "Data Science Project 2 Airline Data"
author: "Jael Rojas"
date: "`r Sys.Date()`"
output:
  html_document:
  code_folding: hide
number_sections: false
#toc: yes
toc_depth: 3
toc_float: yes
pdf_document:
---

The code reads and merges CSV files for January to July, selects relevant columns, preprocesses data, and trains a logistic regression model to predict the probability of a delay (ARR_DEL15 = 1). 
Filter the dataset to include only major U.S. airlines (AA, DL, UA, WN, AS, B6, HA, F9, NK) and restrict the dataset to the top 10 airports reducing dimensionality.

```{r}
library(dplyr)
library(readr)
library(purrr)
library(tidyr)


# Read monthly files
csv_files <- list.files(
  path = "C:/Users/Jael Rojas/Documents/MS_DataScience/DataScience/finalreport/traindata/months",
  pattern = "*.csv", full.names = TRUE
)

flights_list <- csv_files %>%
  map(~ read_csv(.x, show_col_types = FALSE) %>%
        mutate(
          CRS_DEP_TIME = as.character(CRS_DEP_TIME),
          CRS_ARR_TIME = as.character(CRS_ARR_TIME)
        ))

flights_all <- bind_rows(flights_list)

# Keep only major US airlines
major_airlines <- c("AA","DL","UA","WN","AS","B6","HA","F9","NK")

flights_all <- flights_all %>%
  filter(OP_UNIQUE_CARRIER %in% major_airlines)

# Keep top 50 airports by origin frequency (both origin & dest)
top_airports <- flights_all %>%
  count(ORIGIN, sort = TRUE) %>%
  slice_head(n = 10) %>%
  pull(ORIGIN)

flights_all <- flights_all %>%
  filter(ORIGIN %in% top_airports,
         DEST   %in% top_airports)
```
Here, is removed the missing values in the variables that will be used as predictors in the model (ARR_DEL15, carrier, airports, day of week, schedule times, departure delay flag, distance, and month),
then drop the columns that store delay minutes (containg NA mostly) by cancellation information, since they are not usefull for initial prediction.
Is assigned key categorical variables (carrier, origin, destination, departure time block, arrival time block) as factors so that the logistic regression treats them as categorical predictors
rather than numeric values.


```{r}
# Drop NAs only in variables used for prediction
flights_all <- flights_all %>%
  drop_na(ARR_DEL15, OP_UNIQUE_CARRIER, ORIGIN, DEST,
          DAY_OF_WEEK, CRS_DEP_TIME, CRS_ARR_TIME,
          DEP_DEL15, DISTANCE, MONTH)

# Remove cause‑minute columns (used only for post analysis)
flights_all <- flights_all %>%
  select(-CANCELLATION_CODE, -CARRIER_DELAY, -WEATHER_DELAY, -NAS_DELAY,
         -SECURITY_DELAY, -LATE_AIRCRAFT_DELAY)

# Convert categorical predictors to factors
flights_all <- flights_all %>%
  mutate(
    OP_UNIQUE_CARRIER = as.factor(OP_UNIQUE_CARRIER),
    ORIGIN            = as.factor(ORIGIN),
    DEST              = as.factor(DEST),
    DEP_TIME_BLK      = as.factor(DEP_TIME_BLK),
    ARR_TIME_BLK      = as.factor(ARR_TIME_BLK)
  )
```

Split the cleaned dataset into a training set (January–June flights) 
Restrict the training table to ARR_DEL15 and a focused set of predictors describing carrier, route, calendar effects, schedule times, and basic operational variables such as taxi times and diversion flag.

Fit a logistic regression model that predicts the probability of an arrival delay ≥15 minutes from carrier, origin, destination, day of week, distance, month, and departure/arrival time blocks, treating the binary outcome as a binomial response.
```{r}
# Train on months < 7, test on month == 7
train_data <- flights_all %>% filter(MONTH < 7)
test_data  <- flights_all %>% filter(MONTH == 7)

# Keep only needed columns in training set
train_data <- train_data %>%
  select(ARR_DEL15, OP_UNIQUE_CARRIER, ORIGIN, DEST,
         DAY_OF_WEEK, CRS_DEP_TIME, CRS_ARR_TIME,
         DEP_DEL15, DISTANCE, MONTH, YEAR,
         DEP_TIME_BLK, ARR_TIME_BLK, TAXI_OUT, TAXI_IN, DIVERTED)
names(train_data)

model <- glm(
  ARR_DEL15 ~ OP_UNIQUE_CARRIER + ORIGIN + DEST +
    DAY_OF_WEEK + DISTANCE + MONTH +
    DEP_TIME_BLK + ARR_TIME_BLK,
  data = train_data,
  family = binomial
)
summary(model)
```
Interpretation: 

Carriers (vs. baseline carrier):

Alaska Airlines and Frontier have significantly higher log-odds of delay (positive coefficients), meaning higher delay risk than the baseline carrier.

DL: Delta Air Lines
NK: Spirit Airlines
UA: United Airlines
have significantly lower log-odds of delay (negative coefficients), meaning they are less delay on these routes. southest airlines(WN) is similar to the baseline (coefficient small and not significant).

Airports:

Several origin airports (CLT, LAS, LAX, MCO, ORD, PHX, SEA) have negative, highly significant coefficients, indicating lower delay odds than the reference origin, while DEN and DFW are roughly similar to the reference.

On the destination side, DEN and DFW slightly increase delay odds, whereas many others (CLT, LAS, LAX, ORD, PHX, SEA) reduce them relative to the reference destination. This suggests route- and airport-specific congestion patterns.

Calendar:

DAY_OF_WEEK has a small positive coefficient (≈ 0.031, highly significant), so flights later in the week have gradually higher odds of delay (about 3% increase in odds per day).

MONTH has a stronger positive effect (≈ 0.153, highly significant), implying that each later month in the training period raises delay odds by about 17%, reflecting seasonal worsening into spring/summer.


Time-of-day (departure and arrival blocks):

Early-morning departures are the baseline; from mid-morning onward, departure coefficients grow steadily and become large and positive in the afternoon and evening This means flights leaving later in the day have much higher odds of being delayed, consistent with delay propagation.

Arrival blocks show a similar pattern: late-afternoon and evening arrivals have higher delay odds than early-morning arrivals.


Distance:

The distance coefficient is very close to zero and not significant, indicating that once carrier, airports, and time variables are controlled for, flight distance itself does not meaningfully change the probability of a 15+ minute arrival delay in this dataset.

```{r}
library(ggplot2)

time_grid <- expand.grid(
  DEP_TIME_BLK  = levels(train_data$DEP_TIME_BLK),
  ARR_TIME_BLK  = levels(train_data$ARR_TIME_BLK),
  DAY_OF_WEEK   = median(train_data$DAY_OF_WEEK),
  DISTANCE      = median(train_data$DISTANCE),
  MONTH         = median(train_data$MONTH),
  OP_UNIQUE_CARRIER = levels(train_data$OP_UNIQUE_CARRIER)[1],
  ORIGIN        = levels(train_data$ORIGIN)[1],
  DEST          = levels(train_data$DEST)[2]
)

time_grid$prob_delay <- predict(model, newdata = time_grid, type = "response")

ggplot(time_grid,
       aes(x = DEP_TIME_BLK, y = ARR_TIME_BLK, fill = prob_delay)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "red",
                      name = "Predicted delay\nprobability") +
  labs(x = "Departure time block",
       y = "Arrival time block",
       title = "Delay probability by departure and arrival time") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
dep_grid <- expand.grid(
  DEP_TIME_BLK = levels(train_data$DEP_TIME_BLK),
  DAY_OF_WEEK  = median(train_data$DAY_OF_WEEK),
  DISTANCE     = median(train_data$DISTANCE),
  MONTH        = median(train_data$MONTH),
  OP_UNIQUE_CARRIER = levels(train_data$OP_UNIQUE_CARRIER)[1],
  ORIGIN       = levels(train_data$ORIGIN)[1],
  DEST         = levels(train_data$DEST)[2],
  ARR_TIME_BLK = levels(train_data$ARR_TIME_BLK)[1]
)

dep_grid$prob_delay <- predict(model, newdata = dep_grid, type = "response")

ggplot(dep_grid,
       aes(x = DEP_TIME_BLK, y = prob_delay, group = 1)) +
  geom_line(color = "blue") +
  geom_point(color = "blue") +
  labs(x = "Departure time block",
       y = "Predicted delay probability",
       title = "Effect of departure time on delay risk") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


Here is evaluated the logistic regression on July data by computing predicted probabilities, building a ROC curve, and calculating the area under the curve (AUC).
First, it generates predicted probabilities of ARR_DEL15 = 1 for each flight in test_data;
then ROC function compares these probabilities to the true labels to construct the ROC object, 
and AUC function reports the model’s discrimination ability as a single number.

The plotted ROC curve (blue line) bows well above the diagonal reference line, indicating that the model distinguishes delayed from on‑time flights 
better than random; with an AUC around 0.7, it has moderate predictive power, for ranking flights by delay risk).

```{r}
#install.packages("pROC")
library(pROC)

# Predicted probabilities on test set
test_data$pred_prob <- predict(model, newdata = test_data, type = "response")

# ROC object and AUC
roc_obj <- roc(response = test_data$ARR_DEL15,
               predictor = test_data$pred_prob)
auc(roc_obj)        # numeric AUC
plot(roc_obj, col = "blue", main = "ROC curve - flight delay model")
```

Is used the PRROC package to evaluate if the model identifies delayed flights when delays are relatively rare, by computing a precision–recall (PR) curve.
It separates predicted probabilities into scores for delayed flights (fg, foreground) and on‑time flights (bg, background),
then calls pr.curve() to estimate the PR curve and the area under it (auc.integral), and finally plots precision versus recall across all possible thresholds.

The PR curve shows precision of 0.5–0.6 for moderate recall values, with an overall PR‑AUC of about 0.49, which is better than the baseline of the positive rate but still indicates that, 
when trying to capture many delayed flights, the model produces a fair number of false alarms; it is useful for ranking flights by risk but not highly precise at high recall.

```{r}
#install.packages("PRROC") 
library(PRROC)

# Scores for positive (delayed) and negative (on-time) classes
fg <- test_data$pred_prob[test_data$ARR_DEL15 == 1]  # foreground: positives
bg <- test_data$pred_prob[test_data$ARR_DEL15 == 0]  # background: negatives

# PR curve and area under PR curve
pr_obj <- pr.curve(scores.class0 = fg, scores.class1 = bg, curve = TRUE)
pr_obj$auc.integral   

# Plot precision–recall curve
plot(pr_obj, main = "Precision–Recall curve for flight delay model")
```

```{r}
library(caret)  

# Threshold from ROC analysis 
threshold <- 0.5

# Convert probabilities to class predictions
test_data$pred_class <- ifelse(test_data$pred_prob >= threshold, 1, 0)

# Confusion matrix
cm_table <- table(
  Actual = test_data$ARR_DEL15,
  Predicted = test_data$pred_class
)
cm_table

# Metrics using caret
test_data$ARR_DEL15_factor <- factor(test_data$ARR_DEL15, levels = c(0, 1))
test_data$pred_class_factor <- factor(test_data$pred_class, levels = c(0, 1))

cm <- confusionMatrix(
  data = test_data$pred_class_factor,
  reference = test_data$ARR_DEL15_factor,
  positive = "1"
)
cm

library(ggplot2)

# Convert to data frame for ggplot
cm_df <- as.data.frame(cm_table)
colnames(cm_df) <- c("Actual", "Predicted", "Freq")

ggplot(cm_df, aes(x = Predicted, y = Actual, fill = Freq)) +
  geom_tile() +
  geom_text(aes(label = Freq), color = "white", size = 5) +
  scale_fill_gradient(low = "steelblue", high = "darkred") +
  labs(title = "Confusion matrix – flight delay model",
       x = "Predicted class",
       y = "Actual class") +
  theme_minimal()
```

Here we built small “next‑month schedule” and uses the fitted logistic model to forecast delay probabilities, then visualizes those predictions by route and by day of week.
Is defined 10 hypothetical August flights, covering several major carriers (AA, DL, UA, WN, AS, B6, F9, NK) and routes among the top airports, with specified day of week, distance, and departure/arrival time blocks.
Plot a bar chart of predicted delay probability for each carrier–origin–destination combination, with bar color indicating whether the model classifies the flight as delayed (1) or on time (0) at the 0.5 threshold.
Plot a scatter chart of predicted delay probability versus day of week, colored by carrier, to show the risks across the week and between airlines.

```{r}
next_month_data <- data.frame(
  OP_UNIQUE_CARRIER = c("AA","DL","UA","WN","AS","B6","F9","NK","AA","DL"),
  ORIGIN = c("ATL","ATL","ORD","DFW","SEA","LAS","LAX","PHX","DEN","MCO"),
  DEST   = c("CLT","DEN","ATL","LAS","LAX","ORD","SEA","LAX","PHX","ATL"),
  DAY_OF_WEEK = c(1,2,3,4,5,6,7,1,3,5),
  DISTANCE = c(226, 1068, 606, 1055, 954, 1514, 954, 296, 602, 403),  # use real or approximate miles
  MONTH = rep(8, 10),   # e.g., predicting for August
  DEP_TIME_BLK = c("0800-0859","1500-1559","1900-1959","1200-1259","1700-1759",
                   "1000-1059","1400-1459","0600-0659","1600-1659","2000-2059"),
  ARR_TIME_BLK = c("1000-1059","1700-1759","2100-2159","1400-1459","1900-1959",
                   "1200-1259","1600-1659","0800-0859","1800-1859","2200-2259"),
  stringsAsFactors = FALSE
)


next_month_data$OP_UNIQUE_CARRIER <-
  factor(next_month_data$OP_UNIQUE_CARRIER,
         levels = levels(train_data$OP_UNIQUE_CARRIER))

library(dplyr)

next_month_data <- next_month_data %>%
  filter(!is.na(OP_UNIQUE_CARRIER))

next_month_data$ORIGIN <-
  factor(next_month_data$ORIGIN,
         levels = levels(train_data$ORIGIN))

next_month_data$DEST <-
  factor(next_month_data$DEST,
         levels = levels(train_data$DEST))

next_month_data$DEP_TIME_BLK <-
  factor(next_month_data$DEP_TIME_BLK,
         levels = levels(train_data$DEP_TIME_BLK))

next_month_data$ARR_TIME_BLK <-
  factor(next_month_data$ARR_TIME_BLK,
         levels = levels(train_data$ARR_TIME_BLK))
```

```{r}
next_month_data$pred_prob_delay <- predict(
  model,
  newdata = next_month_data,
  type = "response"
)

threshold <- 0.5
next_month_data$pred_delayed_flag <-
  ifelse(next_month_data$pred_prob_delay >= threshold, 1, 0)
next_month_data
```

```{r}

library(ggplot2)

ggplot(next_month_data,
       aes(x = interaction(OP_UNIQUE_CARRIER, ORIGIN, DEST),
           y = pred_prob_delay,
           fill = factor(pred_delayed_flag))) +
  geom_col() +
  labs(x = "Carrier-Origin-Dest",
       y = "Predicted delay probability",
       fill = "Predicted delayed") +
  ylim(0, 1) +
  theme_minimal()
```

```{r}
ggplot(next_month_data,
       aes(x = DAY_OF_WEEK, y = pred_prob_delay,
           color = OP_UNIQUE_CARRIER)) +
  geom_point(size = 3) +
  labs(x = "Day of week",
       y = "Predicted delay probability") +
  ylim(0, 1) +
  theme_minimal()
```


Conclussion: 

- The model predict moderate risk, with 4 of 10 fligths. 
- The prediction for the next moth suggest that airlines as Atlanta, Denmark and Delta presents highest probability to arrive late.
- During the analysis we observe that using only 3 predictor the ROC curve present a fair behavior(flat) with ROC value of 0.5. 
  This result indicated that the probability of prediction is too low or moderate low, consequently we added more than 20 predictors 
  and the new ROC increased to 0.7.   
- An important consideration must be starting from small data and according to the EDA analisys increase tha data size. 
References: 
- https://github.com/wwh9345/Regression-Modeling-US-Airline-On-Time-Performance/blob/main/2006-2007_flight_analysis_prediction.ipynb
- https://www.kaggle.com/code/luiscrmartins/flight-delay-prediction-using-logistic-regression




